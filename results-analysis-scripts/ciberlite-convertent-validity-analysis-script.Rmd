---
title: "CIBERlite: convergent validity"
author: "Gjalt-Jorn Peters & Rik Crutzen"
date: "`r format(Sys.time(), '%H:%M:%S on %Y-%m-%d %Z (GMT%z)')`"
output:
  html_document:
    toc: true
---

# Introduction

## Status of this file

This is the R Markdown file for the "CIBERlite: convergent validity" study. This study is a project of the Academy of Behavior Change. The canonical URL for this study is https://ciberlite.com/convergent-validity. Initially, this will resolve to the study's Open Science Framework repository (https://osf.io/pemfz/), but in time it may point to a website to facilitate CIBERlite implementation by prevention organisations. The study's OSF repository (repo) synchronises with the GitHub repo at https://github.com/academy-of-behavior-change/ciberlite-convergent-validity.

This R Markdown file is very much a living document, and as such, also contains all R code. For the CIBERlite plot, scroll down to the CIBERlite plots heading.

Note that because this is a living project, you will probably need the most up-to-date version of the `userfriendlyscience` package (*if* that has been submitted to CRAN yet). See https://userfriendlyscience.com for instructions as to how to install it.

## Background of the project

CIBERlite is a project where we aim to provide an easy-to-use and apply rudimentary approximation of a determinant study, so that practitioners (e.g. for preventions organisations) can feasibly quickly get an idea of which determinants are the most relevant in predicting a given target behavior in a given target population. To develop this method, we conduct a study comparing relative determinant levels for eight behaviors in the general population.

A second goal of CIBERlite, but only one that only emerged as we were working on this project, is to work towards a framework for calibrating determinant operationalisations over behaviors and populations.

The preregistration form for this study is at https://osf.io/pemfz/register/hvkzr. That is a good place to start before reading further.

## License of these materials

This file and the other materials in the OSF and GitHub repo's associated with this project are licensed under the Creative Commons attribution share alike license (CC-BY-NC-SA; see http://creativecommons.org/licenses/by-nc-sa/4.0/). This means that you are allowed to copy and distribute these files freely, but youâ€™re not allowed to sell them. It also means that if you create derivative works (i.e. if you remix, transform, or build upon the material), you must distribute your contributions under the same license as the original.

# Setup of R environment

Here, we configure some settings and load the required R packages.

```{r setup}

knitr::opts_chunk$set(echo = TRUE);
options(ufs.debug = FALSE);

require('userfriendlyscience');
safeRequire('here');
safeRequire('data.tree');
safeRequire('tidyverse');
safeRequire('gridExtra');
safeRequire('readODS');

dataPath <- here::here('results-data-raw');
processedDataPath <- here::here('results-data-processed');
outputPath <- here::here('results-output');

privateDataFileRegEx <- 'survey_797479_R_data_file_\\[PRIVATE-version]';
publicDataFileRegEx <- 'survey_797479_R_data_file_\\[PUBLIC-version]';
dataLoadScriptName <- 'survey_797479_R_syntax_file.R';

categoricalQuestions <- c('sex',
                          'education',
                          'country');

dataDeletionVarCode <- "dataMustBeDeleted";
dataDeletionSubQuestionCode <- "delete";
dataDeletionVarValue <- "2";
privateFileIdentificationString <- "PRIVATE-";
publicFileIdentificationString <- "PUBLIC-";

### These are the behaviors in this study

behaviors <- c("alcohol", "coffee", "smoking",
               "exercise", "marathon");

###############################################################################
### General settings
###############################################################################

### Load spatial and inhabitation density data for postcodes
pcDat <- data.frame(postcode =  c(10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36, 37, 38, 39, 40, 41, 42, 43, 44, 45, 46, 47, 48, 49, 50, 51, 52, 53, 54, 55, 56, 57, 58, 59, 60, 61, 62, 63, 64, 65, 66, 67, 68, 69, 70, 71, 72, 73, 74, 75, 76, 77, 78, 79, 80, 81, 82, 83, 84, 85, 86, 87, 88, 89, 90, 91, 92, 93, 94, 95, 96, 97, 98, 99),
                    lat = c(52.3678024669572, 52.3455635724132, 52.2501138713815, 52.3585841561271, 52.3735313335077, 52.4657234141959, 52.6830233696612, 52.8198812701222, 52.639550621648, 52.4950689582663, 52.3856186275876, 52.2953703699729, 52.1292546069181, 52.161384292839, 52.1219310706044, 52.0684520747327, 52.0033402777623, 52.0563875683333, 52.0012138989129, 51.8986006453915, 51.9193874565932, 51.9106309680917, 51.8140252861272, 51.8149115339002, 52.0425276819077, 52.0934177824935, 52.1735550175486, 52.1523629740434, 52.223637595618, 52.0279361091616, 51.9054273863578, 51.915733212362, 51.8214914178629, 51.543768240357, 51.4892107569007, 51.3084062814104, 51.5147702745308, 51.5716616062968, 51.5747515937066, 51.6667015879655, 51.5549425996685, 51.6281052353666, 51.6782564610835, 51.7656968848253, 51.6366014520531, 51.3773177941176, 51.4597694831659, 51.4561668812027, 51.5657913844856, 51.3673618493396, 51.2198301363131, 51.0044676214146, 50.8399895742703, 50.8892820844185, 50.8949574101474, 51.8139166230324, 51.8719970570536, 52.0258947138041, 51.9758504258543, 51.9808607088139, 51.9332441744435, 52.0118296962591, 52.1317418255387, 52.2066433697708, 52.2679816480253, 52.2558617315003, 52.3814194800148, 52.5961180135375, 52.7757597738851, 52.7160955644958, 52.4859065597251, 52.3693689406752, 52.5307269978189, 52.747461266424, 52.9652050745035, 52.9094416896853, 53.026376169836, 53.0313126432087, 53.2061363841068, 53.2017360846828, 53.2012055919669, 53.3555306903419, 53.166322821535, 53.1329669620421, 52.9877145107302, 52.9592909500932, 53.1332498567166, 53.2160520411166, 53.2440706462868, 53.3389037688135),
                    lon = c(4.88265296235255, 4.92048844018191, 5.20016981451878, 5.19692084970926, 4.96119798514817, 4.80566389502282, 5.11709329957045, 4.82220173575481, 4.73944411275498, 4.65711588941856, 4.63162288403011, 4.61303752028347, 4.3931852765124, 4.51168737011436, 4.63123989742888, 4.29372836005594, 4.33979586949051, 4.54021535596711, 4.73452186458328, 4.61368753801164, 4.49164782911762, 4.33928060878812, 4.2829687516736, 4.69600707584607, 4.99433000213242, 5.1095360206426, 4.97767698785868, 5.32054575304636, 5.48553597975019, 5.38238247299173, 5.45767067590559, 5.18795319713936, 4.97922665393621, 3.66936390672942, 3.90470966273241, 3.79097509053622, 4.27097697088173, 4.50517380658332, 4.74318639278844, 4.84195733671919, 5.09638240155648, 5.00860229089637, 5.30772679514586, 5.46688460609673, 5.63639617277517, 5.38279769544641, 5.47322994631042, 5.70431204157048, 5.9899379118757, 6.10424312097242, 5.85259175752854, 5.83577253884675, 5.74094339560624, 5.93323298584949, 5.97735784656114, 5.86784740403142, 5.74067359988713, 5.66032248729721, 5.89735875172907, 6.07948324211148, 6.33285411615927, 6.63091103024003, 6.31125395599666, 5.99205974571486, 6.40504947547195, 6.88122082304407, 6.67828479011708, 6.54877480129994, 6.90784259899023, 6.35342435589724, 6.01919757591485, 6.13112521172761, 5.68385478833178, 5.90341298721153, 6.0379057614734, 5.70428744074426, 5.65270524920928, 5.48206467307413, 5.45632660753506, 5.80358549811831, 5.74644474592641, 5.95945766858073, 6.08416956383472, 6.39046332177174, 6.58818166864684, 6.97818596118079, 6.91595201151317, 6.57429045577232, 6.33816563415263, 6.72160735648967),
                    inhabitationDensity = c(6412, 1857, 1831, 1451, 1519, 1679, 1010, 965, 1726, 1706, 2775, 1395, 2121, 2432, 1438, 4891, 1956, 1982, 1693, 1533, 4041, 2432, 1141, 1970, 1282, 3329, 1001, 1175, 1527, 1147, 782, 798, 829, 1101, 672, 559, 1049, 994, 1598, 1149, 2027, 989, 1441, 886, 782, 926, 1766, 1032, 651, 1044, 824, 1010, 1522, 810, 1487, 1783, 715, 1424, 1690, 894, 762, 780, 854, 1464, 1166, 1601, 926, 497, 644, 769, 1267, 538, 1176, 623, 705, 523, 1068, 422, 614, 2268, 337, 366, 674, 600, 790, 508, 703, 2596, 253, 484));

### The inhabitation density is the 'environment address density'. According
### to the Dutch Central Bureau for Statistics, these densities can be
### meaningfully categorized into five degrees of urbanisation:
###
### > 2500 = extremely urban
### > 1500 = very urban
### > 1000 = urban
### > 500  = rural
### < 500  = very rural

pcDat$urbanisation <- cut(pcDat$inhabitationDensity,
                          breaks=c(0, 500, 1000, 1500, 2500, max(pcDat$inhabitationDensity)),
                          labels=c("Very rural",
                                   "Rural",
                                   "Urban",
                                   "Very urban",
                                   "Extremely urban"),
                          ordered_result = TRUE);

```

# Determinant structures

This command builds the determinant structures that we will analyse. This uses very much in-progress code from the `userfriendlyscience` package that leverages the `data.tree` package to build a hierarchy of determinants and sub-determinants.

```{r}

detStruct_original <-
  lapply(behaviors,
         function(behav) {
  return(determinantStructure(behav,
                              list(behaviorRegEx = behav),
                              determinantVar("intention_original",
                                             "_int\\w+",
                                             determinantVar("attitude_original",
                                                            "_att\\w+"),
                                             determinantVar("perceivedNorm_original",
                                                            "_pn\\w+"),
                                             determinantVar("perceivedBehavioralControl_original",
                                                            "_pbc\\w+"))));
});

detStruct_short <-
  lapply(behaviors,
         function(behav) {
  return(determinantStructure(behav,
                              list(behaviorRegEx = behav),
                              determinantVar("intention_short",
                                             "_intPlan",
                                             determinantVar("attitude_short",
                                                            "_attExperPleasant|_attInstrGood"),
                                             determinantVar("perceivedNorm_short",
                                                            "_pnInjunctiveApprove|_pnDescriptiveLikeMe"),
                                             determinantVar("perceivedBehavioralControl_short",
                                                            "_pbcCapacityConfidenc|_pbcControlUpToMe"))));
});

```

# Data import and preprocessing

This includes sanitizing the private data files for publication.

```{r}

########################################################################
###
### Import data
###
########################################################################
###
### First delete the data from students who indicated they want their
### data destroyed (note that this private data file is excluded from
### synchronization with the GitHub repository, and therefore the OSF
### repository, using .gitignore)
###
########################################################################

### Get a list of all data files in data directory
privateDataFiles <-
  list.files(dataPath);

### Select only those matching the regular expression for
### private data files
privateDataFiles <-
  grep(privateDataFileRegEx,
       privateDataFiles,
       value=TRUE);

if (length(privateDataFiles) > 0) {
  ### Private data files are present; this means we run on the PC
  ### of one of the researchers. That means we should sanitize the
  ### datasets and prepare them for publishing.
  
  dataDeletionVarName <- paste0(dataDeletionVarCode,
                              "_",
                              dataDeletionSubQuestionCode);

  ### Loop through the files
  for (currentFilename in privateDataFiles) {
    
    ### Run within local, temporary namespace (so that all variables
    ### are deleted afterwards)
    local({
    
      ### First read in a temporary version of the data
      dat <-
        importLimeSurveyData(datafile = file.path(dataPath,
                                                  currentFilename),
                             datafileRegEx = privateDataFileRegEx,
                             scriptfile = file.path(dataPath,
                                                    dataLoadScriptName),
                             categoricalQuestions = categoricalQuestions);
      
      ### Then get the position of the variable used to indicate whether
      ### data should be deleted:
      dataDeletionVarIndex <-
        grep(dataDeletionVarName, names(dat));
      
      ### Then construct the regular expression for matching the lines in
      ### the dataset that contain the data of participants who indicated
      ### they wanted their data deleted. A regular expression of the
      ### following form is constructed:
      ###
      ### (?:"[^"]*",){75}"2"
      ###
      ### The '75' is the index minus one, and the '2' the value indicating
      ### that data should be deleted. This regular expression matches any
      ### value between a pair of double quotes followed by a comma exactly
      ### 75 times; then matches a '2' between pair of double quotes. This
      ### pair of double quotes contains the value of the 76th variable (so,
      ### in this example, the value of the variable indicating whether data
      ### should be deleted), and therefore, this regular expression matches
      ### all lines containing data that should be deleted.
      
      dataDeletionRegEx <-
        paste0('(?:"[^"]*",){',
               dataDeletionVarIndex-1,
               '}"',
               dataDeletionVarValue,
               '"');
  
      ### Then read the datafile as character vector
      fullPrivateDataFile <-
        readLines(file.path(dataPath,
                            currentFilename));
      cat0("\n\nRead data file '", currentFilename, "'.\n\n");
  
      ### Get indices of lines that have to be deleted
      linesToDelete <- grep(dataDeletionRegEx,
                            fullPrivateDataFile);
      
      ### Log deletion
      cat0("Identified ", length(linesToDelete), " participants who ",
           "indicated they want their data to be deleted, specifically, ",
           "the following lines of the original raw dataset:\n\n",
           vecTxtQ(linesToDelete));
      
      ### Delete those lines
      if (length(linesToDelete) > 0) {
        fullPublicDataFile <- fullPrivateDataFile[-linesToDelete];
      } else {
        fullPublicDataFile <- fullPrivateDataFile;
      }
  
      ### Construct new filename to write public version of data to
      newTmpFilename <- sub(privateFileIdentificationString,
                            publicFileIdentificationString,
                            currentFilename,
                            fixed=TRUE);
      
      ### Store new datafile
      writeLines(fullPublicDataFile,
                 file.path(dataPath,
                           newTmpFilename));
  
      cat0("\n\nStored data file '", newTmpFilename, "'.\n\n");
  
    });  ### End local namespace
  
  }
}

########################################################################
### Import data from public version of the survey
########################################################################

dat <-
  importLimeSurveyData(dataPath = dataPath,
                       datafileRegEx = publicDataFileRegEx,
                       scriptfile = file.path(dataPath,
                                              dataLoadScriptName),
                       categoricalQuestions = categoricalQuestions);

### Add urbanisation using first two numbers of postcode
dat <- merge(dat,
             pcDat[, c('postcode', 'urbanisation')],
             by.x="region", 
             by.y="postcode",
             all.x = TRUE,
             all.y = FALSE);

### Set to missing for participants from another country than the Netherlands
dat$urbanisation[dat$country != "Nederland"] <- NA;

```

# Sample description

The dataset (after sanitization) has `nrow(dat)` rows. `sum(!is.na(dat$submitdate))` rows submitted the complete survey (i.e. have a non-missing value for `submitdate`). Note that providing demographic data was optional, so less data may be available for the demographic variables (age, sex, education, country, and region).

## Age

```{r}
  descr(dat$age);
  powerHist(dat$age);
```

## Sex

```{r}
  descr(dat$sex);
  ggEasyBar(dat, 'sex');
```

## Education

```{r}
  descr(dat$education);
  ggEasyBar(dat, 'education');
```

## Country

```{r}
  descr(dat$country);
```

## Region

We registered the first two numbers of each participant's postcode. For Dutch participants, these were used to compute whether they lived in a rural or urban area.

```{r}
  descr(dat$urbanisation);
```

# Analyses

The aim of this study is to explore the convergent validity of the brief direct measures of the four main constructs as defined in the Reasoned Action Approach: intention, attitude, perceived norms and perceived behavioral control. To this end we compute the correlation coefficients of the original and the brief measures.

```{r results="asis"}

### Add variables names of the determinants' measures and compute
### means where necessary

### Original measures
for (i in seq_along(detStruct_original)) {
  detStructAddVarNames(detStruct_original[[i]], names(dat));
  dat <- detStructComputeScales(detStruct_original[[i]],
                                dat);
}

### Short measures
for (i in seq_along(detStruct_short)) {
  detStructAddVarNames(detStruct_short[[i]], names(dat));
  dat <- detStructComputeScales(detStruct_short[[i]],
                                dat);
}

### Loop through behaviors
for (i in seq_along(behaviors)) {
  cat0("\n\n## ", behaviors[i], "\n");

  cat0("\n- **Intention**: ",
       formatCI(cor.test(dat[, detStruct_original[[i]]$intention_original$scaleVarName],
                         dat[, detStruct_short[[i]]$intention_short$scaleVarName])$conf.int,
                noZero=TRUE));
  
    cat0("\n- **Attitude**: ",
       formatCI(cor.test(dat[, detStruct_original[[i]]$intention_original$attitude_original$scaleVarName],
                         dat[, detStruct_short[[i]]$intention_short$attitude_short$scaleVarName])$conf.int,
                noZero=TRUE));

    cat0("\n- **Perceived norm**: ",
       formatCI(cor.test(dat[, detStruct_original[[i]]$intention_original$perceivedNorm_original$scaleVarName],
                         dat[, detStruct_short[[i]]$intention_short$perceivedNorm_short$scaleVarName])$conf.int,
                noZero=TRUE));

    cat0("\n- **Perceived behavioral control**: ",
       formatCI(cor.test(dat[, detStruct_original[[i]]$intention_original$perceivedBehavioralControl_original$scaleVarName],
                         dat[, detStruct_short[[i]]$intention_short$perceivedBehavioralControl_short$scaleVarName])$conf.int,
                noZero=TRUE));

}

```


